<!DOCTYPE html>
<html lang="pt-BR" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controlo de Gastos - Casamento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SortableJS Library for Drag and Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script>
        // Configuração do Tailwind CSS para o modo escuro
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .task-item.completed .item-name,
        .task-item.completed .item-date,
        .task-item.completed .item-responsible {
            text-decoration: line-through;
            color: #9ca3af;
        }
        .dark .task-item.completed .item-name,
        .dark .task-item.completed .item-date,
        .dark .task-item.completed .item-responsible {
            color: #4b5563;
        }
        .edit-input {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            width: 100%;
        }
        #app-loader {
            display: flex; /* Shown by default now */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .dark #app-loader {
             background-color: rgba(17, 24, 39, 0.8);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Styles for drag and drop */
        .category-card.sortable-ghost, .task-item.sortable-ghost {
            opacity: 0.4;
            background: #dbeafe;
        }
        .dark .category-card.sortable-ghost, .dark .task-item.sortable-ghost {
            background: #374151;
        }
        .handle { cursor: grab; }
        .handle:active { cursor: grabbing; }
        .category-title-text, .main-title-text { cursor: pointer; }
        .view-btn.active {
            background-color: #3B82F6;
            color: white;
        }
        .dark .view-btn.active {
            background-color: #2563EB;
        }
        .calendar-day {
            min-height: 120px;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <!-- App Loader -->
    <div id="app-loader">
        <div class="loader"></div>
    </div>

    <!-- Main App Screen -->
    <div id="main-app" class="hidden">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
            <header class="text-center mb-6 relative">
                <div class="flex justify-center items-center gap-2">
                    <h1 id="main-title-text" class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white">Planeamento de Gastos do Casamento</h1>
                    <button id="edit-main-title-btn" class="text-gray-500 hover:text-blue-600 dark:hover:text-blue-400"><i class="fas fa-pencil-alt"></i></button>
                </div>
                <p class="text-gray-600 dark:text-gray-400 mt-2">ID Partilhado: <strong class="text-blue-600 dark:text-blue-400">pemily1601</strong></p>
                <button id="theme-toggle" class="absolute top-0 right-0 p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none">
                    <i id="theme-toggle-dark-icon" class="fas fa-moon text-xl hidden"></i>
                    <i id="theme-toggle-light-icon" class="fas fa-sun text-xl hidden"></i>
                </button>
            </header>
            
            <div class="flex justify-center mb-8">
                <div class="inline-flex rounded-md shadow-sm" role="group">
                    <button type="button" id="view-kanban-btn" class="view-btn active py-2 px-4 text-sm font-medium text-gray-900 bg-white rounded-l-lg border border-gray-200 hover:bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:text-white dark:hover:bg-gray-600">
                        <i class="fas fa-th-large mr-2"></i>Quadros
                    </button>
                    <button type="button" id="view-list-btn" class="view-btn py-2 px-4 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:text-white dark:hover:bg-gray-600">
                       <i class="fas fa-list-ul mr-2"></i>Lista
                    </button>
                    <button type="button" id="view-calendar-btn" class="view-btn py-2 px-4 text-sm font-medium text-gray-900 bg-white border border-gray-200 hover:bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:text-white dark:hover:bg-gray-600">
                       <i class="fas fa-calendar-alt mr-2"></i>Calendário
                    </button>
                    <button type="button" id="view-dashboard-btn" class="view-btn py-2 px-4 text-sm font-medium text-gray-900 bg-white rounded-r-md border border-gray-200 hover:bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:text-white dark:hover:bg-gray-600">
                       <i class="fas fa-chart-pie mr-2"></i>Dashboard
                    </button>
                </div>
            </div>

            <main id="kanban-view" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Coluna de Categorias -->
                <div class="lg:col-span-2 space-y-8" id="categories-container"></div>

                <!-- Coluna de Resumo e Ações -->
                <aside class="col-span-1 space-y-8 lg:sticky lg:top-8">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 border-b dark:border-gray-700 pb-2">Resumo Geral</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center text-lg"><span class="font-medium text-gray-700 dark:text-gray-300">Custo Total:</span><span id="grand-total" class="font-bold text-blue-600 dark:text-blue-400">R$ 0,00</span></div>
                            <div class="flex justify-between items-center text-lg"><span class="font-medium text-gray-700 dark:text-gray-300">Total Pago:</span><span id="paid-total" class="font-bold text-green-600 dark:text-green-400">R$ 0,00</span></div>
                            <div class="flex justify-between items-center text-lg"><span class="font-medium text-gray-700 dark:text-gray-300">Total Pendente:</span><span id="pending-total" class="font-bold text-red-600 dark:text-red-400">R$ 0,00</span></div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Adicionar Nova Categoria</h3>
                        <div class="flex space-x-2">
                            <input type="text" id="new-category-name" placeholder="Ex: Lua de Mel" class="flex-grow block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <button id="add-category-btn" class="bg-green-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-green-700 transition-colors"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                </aside>
            </main>
            
            <main id="list-view" class="hidden space-y-8">
                <!-- List view content will be generated here -->
            </main>

            <main id="calendar-view" class="hidden bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
                <!-- Calendar view content will be generated here -->
            </main>
            
            <main id="dashboard-view" class="hidden grid grid-cols-1 md:grid-cols-2 gap-8">
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Distribuição por Categoria</h3>
                    <canvas id="expense-chart-category"></canvas>
                </div>
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Gastos por Responsável</h3>
                    <canvas id="expense-chart-responsible"></canvas>
                </div>
            </main>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCzACPqrKvn3R1zeK4kiVK5e3MzjJ7UDQI",
            authDomain: "controle-de-gastos-pemily.firebaseapp.com",
            projectId: "controle-de-gastos-pemily",
            storageBucket: "controle-de-gastos-pemily.appspot.com",
            messagingSenderId: "819710772267",
            appId: "1:819710772267:web:ff4dde111635a6eeef166e",
            measurementId: "G-88JFJ6YTW1"
        };

        // --- DOM ELEMENTS ---
        const appLoader = document.getElementById('app-loader');
        const mainApp = document.getElementById('main-app');
        const mainTitleText = document.getElementById('main-title-text');
        const editMainTitleBtn = document.getElementById('edit-main-title-btn');
        const categoriesContainer = document.getElementById('categories-container');
        const newCategoryNameInput = document.getElementById('new-category-name');
        const addCategoryBtn = document.getElementById('add-category-btn');
        const chartCanvasCategory = document.getElementById('expense-chart-category');
        const chartCanvasResponsible = document.getElementById('expense-chart-responsible');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');
        const lightIcon = document.getElementById('theme-toggle-light-icon');
        const kanbanView = document.getElementById('kanban-view');
        const listView = document.getElementById('list-view');
        const calendarView = document.getElementById('calendar-view');
        const dashboardView = document.getElementById('dashboard-view');
        const viewKanbanBtn = document.getElementById('view-kanban-btn');
        const viewListBtn = document.getElementById('view-list-btn');
        const viewCalendarBtn = document.getElementById('view-calendar-btn');
        const viewDashboardBtn = document.getElementById('view-dashboard-btn');

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let appData = {};
        const currentWeddingId = 'pemily1601';
        let unsubscribe; 
        let categoryChart = null;
        let responsibleChart = null;
        let currentView = 'kanban';
        let calendarDate = new Date();

        const emptyData = {
            title: "Planeamento de Gastos do Casamento",
            categoryOrder: [],
            expenses: {}
        };

        const saveData = async (dataToSave) => {
            if (!currentWeddingId) return;
            try {
                const docRef = doc(db, "weddings", currentWeddingId);
                await setDoc(docRef, dataToSave);
            } catch (error) {
                console.error("Error saving data: ", error);
                alert("Não foi possível salvar os dados.");
            }
        };
        
        const saveAppData = () => saveData(appData);

        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);

        const renderCharts = () => {
            renderCategoryChart();
            renderResponsibleChart();
        };

        const renderCategoryChart = () => {
            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)';
            Chart.defaults.color = textColor;
            const ctx = chartCanvasCategory.getContext('2d');
            const labels = appData.categoryOrder || Object.keys(appData.expenses);
            const data = labels.map(categoryName => (appData.expenses[categoryName] || []).reduce((sum, item) => sum + (item.value || 0), 0));
            const backgroundColors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#6366F1', '#F97316', '#FBBF24', '#22C55E', '#38BDF8', '#FB923C'];
            if (categoryChart) categoryChart.destroy();
            categoryChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ label: 'Gastos por Categoria', data, backgroundColor: (c) => backgroundColors[c.dataIndex % backgroundColors.length], hoverOffset: 4, borderColor: isDarkMode ? '#1f2937' : '#fff' }] }, options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: textColor } }, tooltip: { callbacks: { label: (c) => `${c.label}: ${formatCurrency(c.parsed)}` } } } } });
        };

        const renderResponsibleChart = () => {
            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)';
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            Chart.defaults.color = textColor;
            const ctx = chartCanvasResponsible.getContext('2d');

            const responsibleData = {};
            Object.values(appData.expenses || {}).flat().forEach(item => {
                const responsible = item.responsible || 'N/A';
                if (!responsibleData[responsible]) {
                    responsibleData[responsible] = 0;
                }
                responsibleData[responsible] += item.value || 0;
            });

            const labels = Object.keys(responsibleData);
            const data = Object.values(responsibleData);
            const backgroundColors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'];

            if (responsibleChart) responsibleChart.destroy();
            responsibleChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Gastos por Responsável',
                        data,
                        backgroundColor: (c) => backgroundColors[c.dataIndex % backgroundColors.length],
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    scales: {
                        x: { ticks: { callback: (value) => formatCurrency(value) }, grid: { color: gridColor } },
                        y: { grid: { color: gridColor } }
                    },
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `${c.label}: ${formatCurrency(c.parsed.x)}` } } }
                }
            });
        };
        
        const renderKanbanView = () => {
            categoriesContainer.innerHTML = '';
            let grandTotal = 0, paidTotal = 0;

            (appData.categoryOrder || []).forEach(categoryName => {
                if (!appData.expenses[categoryName]) return;

                const categoryCard = document.createElement('div');
                categoryCard.className = 'bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg category-card';
                categoryCard.dataset.categoryName = categoryName;
                
                let categoryTotal = 0, categoryPaid = 0;
                let itemsHtml = '';

                (appData.expenses[categoryName] || []).forEach((item, index) => {
                    const itemValue = item.value || 0;
                    categoryTotal += itemValue;
                    if(item.completed) { paidTotal += itemValue; categoryPaid += itemValue; }
                    const formattedDate = item.date ? new Date(item.date + 'T00:00:00').toLocaleDateString('pt-BR') : 'Sem data';
                    itemsHtml += `<li class="task-item ${item.completed ? 'completed' : ''}" data-item-id="${categoryName}-${index}"><div class="view-mode flex items-center justify-between py-2 border-b dark:border-gray-700"><div class="flex items-center flex-grow"><i class="fas fa-grip-vertical handle item-handle text-gray-400 dark:text-gray-500 mr-3"></i><input type="checkbox" class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500 cursor-pointer item-checkbox" ${item.completed ? 'checked' : ''}><div class="ml-3 flex-grow"><p class="item-name text-gray-800 dark:text-gray-200">${item.name}</p><p class="text-sm text-gray-500 dark:text-gray-400"><span class="item-date">${formattedDate}</span> <span class="font-semibold item-responsible">(${item.responsible || 'N/A'})</span></p></div></div><div class="flex items-center flex-shrink-0"><span class="font-semibold mr-4 item-value">${formatCurrency(item.value)}</span><button class="edit-btn text-gray-500 hover:text-blue-700 dark:hover:text-blue-400 mr-2"><i class="fas fa-pencil-alt"></i></button><button class="delete-btn text-gray-500 hover:text-red-700 dark:hover:text-red-400"><i class="fas fa-trash-alt"></i></button></div></div><div class="edit-mode hidden flex items-center justify-between py-2 border-b dark:border-gray-700"><div class="flex-grow mr-2 space-y-2"><input type="text" class="edit-input edit-name dark:bg-gray-700 dark:border-gray-600" value="${item.name}"><input type="text" class="edit-input edit-responsible dark:bg-gray-700 dark:border-gray-600" value="${item.responsible || ''}" placeholder="Responsável"><input type="date" class="edit-input edit-date dark:bg-gray-700 dark:border-gray-600" value="${item.date}"><input type="number" step="0.01" class="edit-input edit-value dark:bg-gray-700 dark:border-gray-600" value="${item.value}"></div><button class="save-btn text-green-500 hover:text-green-700 dark:hover:text-green-400"><i class="fas fa-save fa-lg"></i></button></div></li>`;
                });
                grandTotal += categoryTotal;
                itemsHtml += `<li class="add-item-inline-area mt-2"><button class="add-item-inline-btn text-sm text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 w-full text-left p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-plus mr-2"></i> Adicionar um item</button></li>`;
                const categoryPending = categoryTotal - categoryPaid;
                categoryCard.innerHTML = `<h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex justify-between items-center"><div class="flex items-center"><i class="fas fa-grip-vertical handle category-handle text-gray-400 dark:text-gray-500 mr-3"></i><span class="category-title-text">${categoryName}</span><button class="edit-category-title-btn text-gray-400 hover:text-blue-700 dark:hover:text-blue-400 ml-2"><i class="fas fa-pencil-alt fa-xs"></i></button></div><div class="flex items-center"><span class="text-lg text-blue-600 dark:text-blue-400 mr-3">${formatCurrency(categoryTotal)}</span><button class="delete-category-btn text-gray-400 hover:text-red-700 dark:hover:text-red-400" data-category-name="${categoryName}"><i class="fas fa-trash-alt"></i></button></div></h3><ul class="space-y-2 item-list">${itemsHtml}</ul><div class="text-sm mt-3 pt-3 border-t dark:border-gray-700 flex justify-between text-gray-600 dark:text-gray-400"><span>Pago: <strong class="text-green-600 dark:text-green-400">${formatCurrency(categoryPaid)}</strong></span><span>Pendente: <strong class="text-red-600 dark:text-red-400">${formatCurrency(categoryPending)}</strong></span></div>`;
                categoriesContainer.appendChild(categoryCard);
            });
            document.getElementById('grand-total').textContent = formatCurrency(grandTotal);
            document.getElementById('paid-total').textContent = formatCurrency(paidTotal);
            document.getElementById('pending-total').textContent = formatCurrency(grandTotal - paidTotal);
        };

        const renderListView = () => {
            listView.innerHTML = '';
            (appData.categoryOrder || []).forEach(categoryName => {
                if (!appData.expenses[categoryName]) return;
                const categoryCard = document.createElement('div');
                categoryCard.className = 'bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg';
                let itemsHtml = (appData.expenses[categoryName] || []).map((item, index) => {
                    const formattedDate = item.date ? new Date(item.date + 'T00:00:00').toLocaleDateString('pt-BR') : 'Sem data';
                    return `<li class="task-item flex justify-between items-center py-2 border-b dark:border-gray-700 ${item.completed ? 'completed' : ''}" data-item-id="${categoryName}-${index}"><div class="flex items-center"><input type="checkbox" class="item-checkbox h-4 w-4" ${item.completed ? 'checked' : ''}><div class="ml-3"><p class="item-name">${item.name}</p><p class="text-sm text-gray-500 dark:text-gray-400">${formattedDate} (${item.responsible || 'N/A'})</p></div></div><span class="font-semibold">${formatCurrency(item.value)}</span></li>`;
                }).join('');
                categoryCard.innerHTML = `<h3 class="text-xl font-bold mb-4">${categoryName}</h3><ul>${itemsHtml}</ul>`;
                listView.appendChild(categoryCard);
            });
        };

        const renderCalendarView = () => {
            const month = calendarDate.getMonth();
            const year = calendarDate.getFullYear();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const dayNames = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];
            let calendarHtml = `<div class="flex justify-between items-center mb-4"><button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button><h2 class="text-2xl font-bold">${monthNames[month]} ${year}</h2><button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button></div><div class="grid grid-cols-7 gap-1 text-center font-semibold text-gray-600 dark:text-gray-400">${dayNames.map(day => `<div>${day}</div>`).join('')}</div><div class="grid grid-cols-7 gap-1 mt-2">`;
            const eventsByDate = {};
            if (appData.expenses) {
                for (const category in appData.expenses) {
                    appData.expenses[category].forEach(item => {
                        if (item.date) {
                            if (!eventsByDate[item.date]) eventsByDate[item.date] = [];
                            eventsByDate[item.date].push(item);
                        }
                    });
                }
            }
            for (let i = 0; i < firstDay; i++) calendarHtml += `<div></div>`;
            const today = new Date();
            const todayString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = dateString === todayString;
                let eventsHtml = '';
                if (eventsByDate[dateString]) {
                    eventsHtml = eventsByDate[dateString].map(item => {
                        let colorClass = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                        if (item.completed) colorClass = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                        else if ((item.value || 0) === 0) colorClass = 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
                        return `<div class="p-1 rounded-md text-xs truncate ${colorClass}" title="${item.name}">${item.name}</div>`;
                    }).join('');
                }
                calendarHtml += `<div class="calendar-day border dark:border-gray-700 p-2 ${isToday ? 'bg-blue-50 dark:bg-blue-900/50' : ''}"><div class="font-bold text-right">${day}</div><div class="space-y-1 mt-1">${eventsHtml}</div></div>`;
            }
            calendarHtml += `</div>`;
            calendarView.innerHTML = calendarHtml;
            document.getElementById('prev-month-btn').addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() - 1); renderCalendarView(); });
            document.getElementById('next-month-btn').addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() + 1); renderCalendarView(); });
        };

        const render = () => {
            if (!appData.expenses) return;
            mainTitleText.textContent = appData.title || emptyData.title;
            if (currentView === 'kanban') {
                renderKanbanView();
                initSortable();
            } else if (currentView === 'list') {
                renderListView();
            } else if (currentView === 'calendar') {
                renderCalendarView();
            } else {
                renderCharts();
            }
        };

        const initSortable = () => {
            new Sortable(categoriesContainer, { animation: 150, handle: '.category-handle', onEnd: (evt) => { const movedItem = appData.categoryOrder.splice(evt.oldIndex, 1)[0]; appData.categoryOrder.splice(evt.newIndex, 0, movedItem); saveAppData(); } });
            document.querySelectorAll('.item-list').forEach(list => { new Sortable(list, { group: 'shared', animation: 150, handle: '.item-handle', onEnd: (evt) => { const fromCat = evt.from.closest('.category-card').dataset.categoryName; const toCat = evt.to.closest('.category-card').dataset.categoryName; const [movedItem] = appData.expenses[fromCat].splice(evt.oldIndex, 1); if (!appData.expenses[toCat]) appData.expenses[toCat] = []; appData.expenses[toCat].splice(evt.newIndex, 0, movedItem); saveAppData(); } }); });
        };

        const startApp = (weddingId) => {
            mainApp.classList.remove('hidden');
            appLoader.style.display = 'flex';
            const docRef = doc(db, "weddings", weddingId);
            unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    appData = docSnap.data();
                    if (!appData.categoryOrder || appData.categoryOrder.length !== Object.keys(appData.expenses).length) {
                        appData.categoryOrder = Object.keys(appData.expenses);
                    }
                } else {
                    appData = JSON.parse(JSON.stringify(emptyData));
                    saveData(appData); 
                }
                render();
                appLoader.style.display = 'none';
            }, (error) => {
                console.error("Firestore snapshot error:", error);
                alert("Falha na ligação à base de dados.");
                appLoader.style.display = 'none';
            });
        };

        editMainTitleBtn.addEventListener('click', () => {
            const currentTitle = mainTitleText.textContent;
            const newTitle = prompt("Insira o novo título do planeamento:", currentTitle);
            if (newTitle && newTitle.trim() !== currentTitle) {
                appData.title = newTitle.trim();
                saveData(appData);
            }
        });

        categoriesContainer.addEventListener('click', (e) => {
            const taskItem = e.target.closest('.task-item');
            const categoryBtn = e.target.closest('.delete-category-btn');
            const addItemBtnInline = e.target.closest('.add-item-inline-btn');
            const editCategoryBtn = e.target.closest('.edit-category-title-btn');

            if (editCategoryBtn) {
                const h3 = editCategoryBtn.closest('h3');
                const titleSpan = h3.querySelector('.category-title-text');
                const oldCategoryName = titleSpan.textContent;
                const input = document.createElement('input');
                input.type = 'text';
                input.value = oldCategoryName;
                input.className = 'edit-input text-xl font-bold dark:bg-gray-700 dark:border-gray-600';
                titleSpan.style.display = 'none';
                h3.querySelector('.handle').style.display = 'none';
                titleSpan.parentElement.insertBefore(input, titleSpan);
                input.focus();
                input.select();
                const saveTitle = () => {
                    const newCategoryName = input.value.trim();
                    if (newCategoryName && newCategoryName !== oldCategoryName) {
                        if (appData.expenses.hasOwnProperty(newCategoryName)) {
                            alert('Essa categoria já existe.');
                            titleSpan.style.display = '';
                            h3.querySelector('.handle').style.display = '';
                            input.remove();
                            return;
                        }
                        const oldOrderIndex = appData.categoryOrder.indexOf(oldCategoryName);
                        appData.categoryOrder.splice(oldOrderIndex, 1, newCategoryName);
                        appData.expenses[newCategoryName] = appData.expenses[oldCategoryName];
                        delete appData.expenses[oldCategoryName];
                        saveAppData();
                    } else {
                        titleSpan.style.display = '';
                        h3.querySelector('.handle').style.display = '';
                        input.remove();
                    }
                };
                input.addEventListener('blur', saveTitle);
                input.addEventListener('keydown', (evt) => { if (evt.key === 'Enter') input.blur(); else if (evt.key === 'Escape') { titleSpan.style.display = ''; h3.querySelector('.handle').style.display = ''; input.remove(); } });
            } else if (taskItem) {
                const [category, itemIndex] = taskItem.dataset.itemId.split('-');
                const index = parseInt(itemIndex);
                if (e.target.closest('.edit-btn')) {
                    taskItem.querySelector('.view-mode').classList.add('hidden');
                    taskItem.querySelector('.edit-mode').classList.remove('hidden');
                } else if (e.target.closest('.save-btn')) {
                    const editMode = taskItem.querySelector('.edit-mode');
                    appData.expenses[category][index].name = editMode.querySelector('.edit-name').value;
                    appData.expenses[category][index].responsible = editMode.querySelector('.edit-responsible').value;
                    appData.expenses[category][index].date = editMode.querySelector('.edit-date').value;
                    appData.expenses[category][index].value = parseFloat(editMode.querySelector('.edit-value').value) || 0;
                    saveAppData();
                } else if (e.target.closest('.delete-btn')) {
                    appData.expenses[category].splice(index, 1);
                    saveAppData();
                } else if (e.target.classList.contains('item-checkbox')) {
                    appData.expenses[category][index].completed = e.target.checked;
                    saveAppData();
                }
            } else if (categoryBtn) {
                const categoryNameToDelete = categoryBtn.dataset.categoryName;
                if (confirm(`Tem a certeza que quer apagar a categoria "${categoryNameToDelete}" e todos os seus itens?`)) {
                    delete appData.expenses[categoryNameToDelete];
                    appData.categoryOrder = appData.categoryOrder.filter(name => name !== categoryNameToDelete);
                    saveAppData();
                }
            } else if (addItemBtnInline) {
                const categoryName = addItemBtnInline.closest('.category-card').dataset.categoryName;
                appData.expenses[categoryName].push({ name: "Novo Item", value: 0, date: "", responsible: "", completed: false });
                saveAppData().then(() => {
                    const items = document.querySelector(`.category-card[data-category-name="${categoryName}"]`).querySelectorAll('.task-item');
                    const newItem = items[items.length - 1];
                    if (newItem) {
                        newItem.querySelector('.edit-btn').click();
                        newItem.querySelector('.edit-name').focus();
                        newItem.querySelector('.edit-name').select();
                    }
                });
            }
        });

        addCategoryBtn.addEventListener('click', () => {
            const name = newCategoryNameInput.value.trim();
            if (name && !appData.expenses.hasOwnProperty(name)) {
                appData.expenses[name] = [];
                appData.categoryOrder.push(name);
                newCategoryNameInput.value = '';
                saveAppData();
            } else if (name) {
                alert('Essa categoria já existe.');
            }
        });
        
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                darkIcon.classList.remove('hidden');
                lightIcon.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                darkIcon.classList.add('hidden');
                lightIcon.classList.remove('hidden');
            }
            if (appData.expenses) render();
        };

        themeToggleBtn.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            const newTheme = isDark ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        const switchView = (view) => {
            currentView = view;
            [kanbanView, listView, calendarView, dashboardView].forEach(v => v.classList.add('hidden'));
            [viewKanbanBtn, viewListBtn, viewCalendarBtn, viewDashboardBtn].forEach(b => b.classList.remove('active'));

            if (view === 'kanban') {
                kanbanView.classList.remove('hidden');
                viewKanbanBtn.classList.add('active');
            } else if (view === 'list') {
                listView.classList.remove('hidden');
                viewListBtn.classList.add('active');
            } else if (view === 'calendar') {
                calendarView.classList.remove('hidden');
                viewCalendarBtn.classList.add('active');
            } else if (view === 'dashboard') {
                dashboardView.classList.remove('hidden');
                viewDashboardBtn.classList.add('active');
            }
            render();
        };

        viewKanbanBtn.addEventListener('click', () => switchView('kanban'));
        viewListBtn.addEventListener('click', () => switchView('list'));
        viewCalendarBtn.addEventListener('click', () => switchView('calendar'));
        viewDashboardBtn.addEventListener('click', () => switchView('dashboard'));

        const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        applyTheme(savedTheme);
        startApp(currentWeddingId);

    </script>
</body>
</html>
