<!DOCTYPE html>
<html lang="pt-BR" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Gastos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SortableJS Library for Drag and Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <!-- SheetJS (xlsx) Library for Spreadsheet Parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .task-item.completed .item-name, .task-item.completed .item-date, .task-item.completed .item-responsible { text-decoration: line-through; color: #9ca3af; }
        .dark .task-item.completed .item-name, .dark .task-item.completed .item-date, .dark .task-item.completed .item-responsible { color: #4b5563; }
        .edit-input { border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.25rem 0.5rem; width: 100%; }
        #app-loader { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); z-index: 9999; justify-content: center; align-items: center; }
        .dark #app-loader { background-color: rgba(17, 24, 39, 0.8); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .category-card.sortable-ghost, .task-item.sortable-ghost { opacity: 0.4; background: #dbeafe; }
        .dark .category-card.sortable-ghost, .dark .task-item.sortable-ghost { background: #374151; }
        .handle { cursor: grab; }
        .handle:active { cursor: grabbing; }
        .category-title-text, .main-title-text { cursor: pointer; }
        .view-btn { color: #374151; background-color: white; border: 1px solid #e5e7eb; }
        .dark .view-btn { color: #d1d5db; background-color: #374151; border-color: #4b5563; }
        .view-btn:hover { background-color: #f9fafb; }
        .dark .view-btn:hover { background-color: #4b5563; }
        .view-btn.active { background-color: #3B82F6; color: white; border-color: #3B82F6; }
        .dark .view-btn.active { background-color: #2563EB; border-color: #2563EB; }
        .calendar-day { min-height: 120px; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <div id="app-loader"><div class="loader"></div></div>

    <!-- Auth Screen -->
    <div id="auth-screen" class="hidden">
        <div class="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900">
            <div class="max-w-md w-full bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-lg">
                <h2 class="text-3xl font-bold text-center text-gray-900 dark:text-white mb-6">Bem-vindo</h2>
                <div class="space-y-4">
                    <input id="auth-email" type="email" placeholder="Email" class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600">
                    <input id="auth-password" type="password" placeholder="Palavra-passe" class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div class="flex gap-4 mt-6">
                    <button id="login-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Entrar</button>
                    <button id="register-btn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Registar</button>
                </div>
                 <p id="auth-error" class="text-red-500 text-sm mt-4 text-center"></p>
            </div>
        </div>
    </div>

    <!-- Board Selection Screen -->
    <div id="board-selection-screen" class="hidden">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
             <header class="text-center mb-10 relative">
                <h1 class="text-4xl font-bold text-gray-900 dark:text-white">Meus Quadros</h1>
                <button id="logout-btn" class="absolute top-0 right-0 p-2 text-sm text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400">Sair <i class="fas fa-sign-out-alt ml-1"></i></button>
            </header>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg mb-8">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Criar Novo Quadro</h3>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="new-board-name" placeholder="Nome do Novo Quadro" class="flex-grow w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700">
                    <button id="add-board-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Criar</button>
                    <button id="create-from-sheet-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700"><i class="fas fa-file-excel mr-2"></i>Criar de Planilha</button>
                    <input type="file" id="create-board-file-input" class="hidden" accept=".csv, .xlsx, .xls">
                </div>
            </div>
            <div id="board-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
        </div>
    </div>

    <!-- Main App Screen (Single Board View) -->
    <div id="main-app" class="hidden">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
            <header class="text-center mb-6 relative">
                 <button id="back-to-boards-btn" class="absolute top-0 left-0 p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fas fa-arrow-left text-xl"></i></button>
                <div class="flex justify-center items-center gap-2">
                    <h1 id="main-title-text" class="text-3xl md:text-4xl font-bold"></h1>
                    <button id="edit-main-title-btn" class="text-gray-500 hover:text-blue-600"><i class="fas fa-pencil-alt"></i></button>
                    <button id="share-btn" class="text-gray-500 hover:text-green-600"><i class="fas fa-user-plus"></i></button>
                </div>
                <button id="theme-toggle" class="absolute top-0 right-0 p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i id="theme-toggle-dark-icon" class="fas fa-moon text-xl hidden"></i>
                    <i id="theme-toggle-light-icon" class="fas fa-sun text-xl hidden"></i>
                </button>
            </header>
            
            <div class="flex justify-center mb-8">
                <div class="inline-flex rounded-md shadow-sm" role="group">
                    <button type="button" id="view-kanban-btn" class="view-btn active py-2 px-4 text-sm font-medium rounded-l-lg"><i class="fas fa-th-large mr-2"></i>Quadros</button>
                    <button type="button" id="view-list-btn" class="view-btn py-2 px-4 text-sm font-medium"><i class="fas fa-list-ul mr-2"></i>Lista</button>
                    <button type="button" id="view-calendar-btn" class="view-btn py-2 px-4 text-sm font-medium"><i class="fas fa-calendar-alt mr-2"></i>Calendário</button>
                    <button type="button" id="view-dashboard-btn" class="view-btn py-2 px-4 text-sm font-medium rounded-r-md"><i class="fas fa-chart-pie mr-2"></i>Dashboard</button>
                </div>
            </div>

            <main id="kanban-view" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-8" id="categories-container"></div>
                <aside class="col-span-1 space-y-8 lg:sticky lg:top-8">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2">Resumo Geral</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center text-lg"><span>Custo Total:</span><span id="grand-total" class="font-bold text-blue-600">R$ 0,00</span></div>
                            <div class="flex justify-between items-center text-lg"><span>Total Pago:</span><span id="paid-total" class="font-bold text-green-600">R$ 0,00</span></div>
                            <div class="flex justify-between items-center text-lg"><span>Total Pendente:</span><span id="pending-total" class="font-bold text-red-600">R$ 0,00</span></div>
                        </div>
                    </div>
                    <div id="add-category-widget" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">Adicionar Categoria</h3>
                        <div class="flex space-x-2">
                            <input type="text" id="new-category-name" placeholder="Ex: Lua de Mel" class="flex-grow w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700">
                            <button id="add-category-btn" class="bg-green-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-green-700"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                     <div id="tools-widget" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">Ferramentas</h3>
                        <div class="space-y-3">
                            <button id="export-csv-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700"><i class="fas fa-file-csv mr-2"></i>Exportar</button>
                            <button id="import-csv-btn" class="w-full bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 mt-2"><i class="fas fa-file-import mr-2"></i>Importar</button>
                            <input type="file" id="import-file-input" class="hidden" accept=".csv, .xlsx, .xls">
                        </div>
                    </div>
                </aside>
            </main>
            
            <main id="list-view" class="hidden space-y-8"></main>
            <main id="calendar-view" class="hidden bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg"></main>
            <main id="dashboard-view" class="hidden grid grid-cols-1 md:grid-cols-2 gap-8">
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-bold mb-4">Distribuição por Categoria</h3><canvas id="expense-chart-category"></canvas></div>
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-bold mb-4">Gastos por Responsável</h3><canvas id="expense-chart-responsible"></canvas></div>
            </main>
        </div>
    </div>
    
    <!-- Share Modal -->
    <div id="share-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Partilhar Quadro</h2>
                <button id="close-share-modal-btn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200">&times;</button>
            </div>
            <div class="mb-4">
                <h3 class="font-semibold mb-2">Convidar novo membro</h3>
                <div class="flex gap-2">
                    <input type="email" id="invite-email-input" placeholder="Email do utilizador" class="flex-grow rounded-md border-gray-300 dark:bg-gray-700">
                    <select id="invite-role-select" class="rounded-md border-gray-300 dark:bg-gray-700">
                        <option value="viewer">Visualizador</option>
                        <option value="editor">Editor</option>
                    </select>
                    <button id="invite-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Convidar</button>
                </div>
            </div>
            <div>
                <h3 class="font-semibold mb-2">Membros Actuais</h3>
                <ul id="members-list" class="space-y-2"></ul>
            </div>
        </div>
    </div>


    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, deleteDoc, collection, query, where, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCzACPqrKvn3R1zeK4kiVK5e3MzjJ7UDQI",
            authDomain: "controle-de-gastos-pemily.firebaseapp.com",
            projectId: "controle-de-gastos-pemily",
            storageBucket: "controle-de-gastos-pemily.appspot.com",
            messagingSenderId: "819710772267",
            appId: "1:819710772267:web:ff4dde111635a6eeef166e",
            measurementId: "G-88JFJ6YTW1"
        };

        // --- DOM ELEMENTS ---
        const appLoader = document.getElementById('app-loader');
        const authScreen = document.getElementById('auth-screen');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const authError = document.getElementById('auth-error');
        const boardSelectionScreen = document.getElementById('board-selection-screen');
        const boardList = document.getElementById('board-list');
        const newBoardNameInput = document.getElementById('new-board-name');
        const addBoardBtn = document.getElementById('add-board-btn');
        const createFromSheetBtn = document.getElementById('create-from-sheet-btn');
        const createBoardFileInput = document.getElementById('create-board-file-input');
        const logoutBtn = document.getElementById('logout-btn');
        const mainApp = document.getElementById('main-app');
        const mainTitleText = document.getElementById('main-title-text');
        const editMainTitleBtn = document.getElementById('edit-main-title-btn');
        const shareBtn = document.getElementById('share-btn');
        const backToBoardsBtn = document.getElementById('back-to-boards-btn');
        const categoriesContainer = document.getElementById('categories-container');
        const newCategoryNameInput = document.getElementById('new-category-name');
        const addCategoryBtn = document.getElementById('add-category-btn');
        const chartCanvasCategory = document.getElementById('expense-chart-category');
        const chartCanvasResponsible = document.getElementById('expense-chart-responsible');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');
        const lightIcon = document.getElementById('theme-toggle-light-icon');
        const kanbanView = document.getElementById('kanban-view');
        const listView = document.getElementById('list-view');
        const calendarView = document.getElementById('calendar-view');
        const dashboardView = document.getElementById('dashboard-view');
        const viewKanbanBtn = document.getElementById('view-kanban-btn');
        const viewListBtn = document.getElementById('view-list-btn');
        const viewCalendarBtn = document.getElementById('view-calendar-btn');
        const viewDashboardBtn = document.getElementById('view-dashboard-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const importCsvBtn = document.getElementById('import-csv-btn');
        const importFileInput = document.getElementById('import-file-input');
        const shareModal = document.getElementById('share-modal');
        const closeShareModalBtn = document.getElementById('close-share-modal-btn');
        const inviteEmailInput = document.getElementById('invite-email-input');
        const inviteRoleSelect = document.getElementById('invite-role-select');
        const inviteBtn = document.getElementById('invite-btn');
        const membersList = document.getElementById('members-list');
        
        const addCategoryWidget = document.getElementById('add-category-widget');
        const toolsWidget = document.getElementById('tools-widget');


        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let appData = {};
        let currentUser = null;
        let currentPlanId = null;
        let unsubscribe; 
        let categoryChart = null;
        let responsibleChart = null;
        let currentView = 'kanban';
        let calendarDate = new Date();
        
        const emptyData = {
            title: "Novo Planeamento",
            categoryOrder: [],
            expenses: {},
            owner: "",
            members: {},
            memberIds: []
        };
        
        const saveData = async (planId, dataToSave) => {
            if (!planId) return;
            try {
                const docRef = doc(db, "plans", planId);
                await setDoc(docRef, dataToSave, { merge: true });
            } catch (error) {
                console.error("Error saving data: ", error);
                alert("Não foi possível salvar os dados.");
            }
        };
        
        const saveCurrentPlanData = () => saveData(currentPlanId, appData);

        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);

        const renderCharts = () => {
             if (!appData.expenses) return;
            renderCategoryChart();
            renderResponsibleChart();
        };

        const renderCategoryChart = () => {
            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)';
            Chart.defaults.color = textColor;
            const ctx = chartCanvasCategory.getContext('2d');
            const labels = appData.categoryOrder || Object.keys(appData.expenses);
            const data = labels.map(categoryName => (appData.expenses[categoryName] || []).reduce((sum, item) => sum + (parseFloat(item.value) || 0), 0));
            const backgroundColors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#6366F1', '#F97316', '#FBBF24', '#22C55E', '#38BDF8', '#FB923C'];
            if (categoryChart) categoryChart.destroy();
            categoryChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ label: 'Gastos por Categoria', data, backgroundColor: (c) => backgroundColors[c.dataIndex % backgroundColors.length], hoverOffset: 4, borderColor: isDarkMode ? '#1f2937' : '#fff' }] }, options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: textColor } }, tooltip: { callbacks: { label: (c) => `${c.label}: ${formatCurrency(c.parsed)}` } } } } });
        };

        const renderResponsibleChart = () => {
            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)';
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            Chart.defaults.color = textColor;
            const ctx = chartCanvasResponsible.getContext('2d');

            const responsibleData = {};
            Object.values(appData.expenses || {}).flat().forEach(item => {
                const responsible = item.responsible || 'N/A';
                if (!responsibleData[responsible]) {
                    responsibleData[responsible] = 0;
                }
                responsibleData[responsible] += parseFloat(item.value) || 0;
            });

            const labels = Object.keys(responsibleData);
            const data = Object.values(responsibleData);
            const backgroundColors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'];

            if (responsibleChart) responsibleChart.destroy();
            responsibleChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Gastos por Responsável',
                        data,
                        backgroundColor: (c) => backgroundColors[c.dataIndex % backgroundColors.length],
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    scales: {
                        x: { ticks: { callback: (value) => formatCurrency(value) }, grid: { color: gridColor } },
                        y: { grid: { color: gridColor } }
                    },
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `${c.label}: ${formatCurrency(c.parsed.x)}` } } }
                }
            });
        };
        
        const renderKanbanView = () => {
            categoriesContainer.innerHTML = '';
            let grandTotal = 0, paidTotal = 0;

            const userRole = appData.members[currentUser.uid];
            const canEdit = userRole === 'owner' || userRole === 'editor';

            (appData.categoryOrder || []).forEach(categoryName => {
                if (!appData.expenses[categoryName]) return;

                const categoryCard = document.createElement('div');
                categoryCard.className = 'bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg category-card';
                categoryCard.dataset.categoryName = categoryName;
                
                let categoryTotal = 0, categoryPaid = 0;
                let itemsHtml = '';

                (appData.expenses[categoryName] || []).forEach((item, index) => {
                    const itemValue = parseFloat(item.value) || 0;
                    categoryTotal += itemValue;
                    if(item.completed) { paidTotal += itemValue; categoryPaid += itemValue; }
                    const formattedDate = item.date ? new Date(item.date + 'T00:00:00').toLocaleDateString('pt-BR') : 'Sem data';
                    itemsHtml += `<li class="task-item ${item.completed ? 'completed' : ''}" data-category="${categoryName}" data-index="${index}">
                        <div class="view-mode flex items-center justify-between py-2 border-b dark:border-gray-700">
                            <div class="flex items-center flex-grow">
                                ${canEdit ? '<i class="fas fa-grip-vertical handle item-handle text-gray-400 dark:text-gray-500 mr-3"></i>' : ''}
                                <input type="checkbox" class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500 cursor-pointer item-checkbox" ${item.completed ? 'checked' : ''} ${!canEdit ? 'disabled' : ''}>
                                <div class="ml-3 flex-grow"><p class="item-name text-gray-800 dark:text-gray-200">${item.name}</p><p class="text-sm text-gray-500 dark:text-gray-400"><span class="item-date">${formattedDate}</span> <span class="font-semibold item-responsible">(${item.responsible || 'N/A'})</span></p></div>
                            </div>
                            <div class="flex items-center flex-shrink-0">
                                <span class="font-semibold mr-4 item-value">${formatCurrency(item.value)}</span>
                                ${canEdit ? `<button class="edit-btn text-gray-500 hover:text-blue-700 dark:hover:text-blue-400 mr-2"><i class="fas fa-pencil-alt"></i></button><button class="delete-btn text-gray-500 hover:text-red-700 dark:hover:text-red-400"><i class="fas fa-trash-alt"></i></button>` : ''}
                            </div>
                        </div>
                        <div class="edit-mode hidden flex items-center justify-between py-2 border-b dark:border-gray-700">
                            <div class="flex-grow mr-2 space-y-2">
                                <input type="text" class="edit-input edit-name dark:bg-gray-700 dark:border-gray-600" value="${item.name}">
                                <input type="text" class="edit-input edit-responsible dark:bg-gray-700 dark:border-gray-600" value="${item.responsible || ''}" placeholder="Responsável">
                                <input type="date" class="edit-input edit-date dark:bg-gray-700 dark:border-gray-600" value="${item.date}">
                                <input type="number" step="0.01" class="edit-input edit-value dark:bg-gray-700 dark:border-gray-600" value="${item.value}">
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="save-btn text-green-500 hover:text-green-700 dark:hover:text-green-400"><i class="fas fa-save fa-lg"></i></button>
                                <button class="cancel-btn text-red-500 hover:text-red-700 dark:hover:text-red-400"><i class="fas fa-times fa-lg"></i></button>
                            </div>
                        </div>
                    </li>`;
                });
                grandTotal += categoryTotal;
                if (canEdit) {
                    itemsHtml += `<li class="add-item-inline-area mt-2"><button class="add-item-inline-btn text-sm text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 w-full text-left p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-plus mr-2"></i> Adicionar um item</button></li>`;
                }
                const categoryPending = categoryTotal - categoryPaid;
                categoryCard.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex justify-between items-center">
                        <div class="flex items-center">
                            ${canEdit ? '<i class="fas fa-grip-vertical handle category-handle text-gray-400 dark:text-gray-500 mr-3"></i>' : ''}
                            <span class="category-title-text">${categoryName}</span>
                             ${canEdit ? `<button class="edit-category-title-btn text-gray-400 hover:text-blue-700 dark:hover:text-blue-400 ml-2"><i class="fas fa-pencil-alt fa-xs"></i></button>` : ''}
                        </div>
                        <div class="flex items-center">
                            <span class="text-lg text-blue-600 dark:text-blue-400 mr-3">${formatCurrency(categoryTotal)}</span>
                            ${canEdit ? `<button class="delete-category-btn text-gray-400 hover:text-red-700 dark:hover:text-red-400" data-category-name="${categoryName}"><i class="fas fa-trash-alt"></i></button>` : ''}
                        </div>
                    </h3>
                    <ul class="space-y-2 item-list">${itemsHtml}</ul>
                    <div class="text-sm mt-3 pt-3 border-t dark:border-gray-700 flex justify-between text-gray-600 dark:text-gray-400">
                        <span>Pago: <strong class="text-green-600 dark:text-green-400">${formatCurrency(categoryPaid)}</strong></span>
                        <span>Pendente: <strong class="text-red-600 dark:text-red-400">${formatCurrency(categoryPending)}</strong></span>
                    </div>`;
                categoriesContainer.appendChild(categoryCard);
            });
            document.getElementById('grand-total').textContent = formatCurrency(grandTotal);
            document.getElementById('paid-total').textContent = formatCurrency(paidTotal);
            document.getElementById('pending-total').textContent = formatCurrency(grandTotal - paidTotal);

            // Hide editing widgets if user is a viewer
            addCategoryWidget.style.display = canEdit ? 'block' : 'none';
            toolsWidget.style.display = canEdit ? 'block' : 'none';
            editMainTitleBtn.style.display = canEdit ? 'inline-block' : 'none';
        };

        const renderListView = () => {
             // ... implementation for list view based on permissions
        };

        const renderCalendarView = () => {
             // ... implementation for calendar view
        };

        const render = () => {
            if (!appData.expenses) return;
            mainTitleText.textContent = appData.title || "Sem Título";
            if (currentView === 'kanban') {
                renderKanbanView();
                initSortable();
            } else if (currentView === 'list') {
                renderListView();
            } else if (currentView === 'calendar') {
                renderCalendarView();
            } else {
                renderCharts();
            }
        };

        const initSortable = () => {
            const userRole = appData.members[currentUser.uid];
            const canEdit = userRole === 'owner' || userRole === 'editor';
            if (!canEdit) return;

            new Sortable(categoriesContainer, { animation: 150, handle: '.category-handle', onEnd: (evt) => { const movedItem = appData.categoryOrder.splice(evt.oldIndex, 1)[0]; appData.categoryOrder.splice(evt.newIndex, 0, movedItem); saveCurrentPlanData(); } });
            document.querySelectorAll('.item-list').forEach(list => { new Sortable(list, { group: 'shared', animation: 150, handle: '.item-handle', onEnd: (evt) => { const fromCat = evt.from.closest('.category-card').dataset.categoryName; const toCat = evt.to.closest('.category-card').dataset.categoryName; const [movedItem] = appData.expenses[fromCat].splice(evt.oldIndex, 1); if (!appData.expenses[toCat]) appData.expenses[toCat] = []; appData.expenses[toCat].splice(evt.newIndex, 0, movedItem); saveCurrentPlanData(); } }); });
        };

        const loadPlan = (planId) => {
            currentPlanId = planId;
            boardSelectionScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            appLoader.style.display = 'flex';
            
            if (unsubscribe) unsubscribe();

            const docRef = doc(db, "plans", planId);
            unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().expenses) {
                    appData = docSnap.data();
                } else {
                    appData = JSON.parse(JSON.stringify(emptyData));
                    appData.title = "Quadro Corrompido";
                }
                render();
                appLoader.style.display = 'none';
            }, (error) => {
                console.error("Firestore snapshot error:", error);
                alert("Erro ao carregar o quadro. Verifique as suas permissões.");
                showBoardSelection();
            });
        };

        const showBoardSelection = async () => {
            if(unsubscribe) unsubscribe();
            currentPlanId = null;

            boardSelectionScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');
            appLoader.style.display = 'flex';
            
            // MIGRATION LOGIC FOR OLD 'pemily1601' board
            const migrationKey = `migration_v2_claimed_by_${currentUser.uid}`;
            if (!localStorage.getItem(migrationKey)) {
                const oldPlanRef = doc(db, "plans", "pemily1601");
                const oldPlanSnap = await getDoc(oldPlanRef);
                if (oldPlanSnap.exists() && !oldPlanSnap.data().owner) {
                     await updateDoc(oldPlanRef, {
                        owner: currentUser.uid,
                        members: { [currentUser.uid]: 'owner' },
                        memberIds: [currentUser.uid]
                    });
                     alert("O seu quadro 'pemily1601' foi associado à sua nova conta!");
                }
                localStorage.setItem(migrationKey, 'true');
            }


            const q = query(collection(db, "plans"), where("memberIds", "array-contains", currentUser.uid));
            const querySnapshot = await getDocs(q);

            boardList.innerHTML = '';
            querySnapshot.forEach((doc) => {
                const planId = doc.id;
                const planTitle = doc.data().title || "Quadro sem nome";
                const card = document.createElement('div');
                card.className = 'bg-white dark:bg-gray-700 p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer flex justify-between items-center';
                card.dataset.planId = planId;
                card.innerHTML = `<h3 class="text-lg font-semibold">${planTitle}</h3>${doc.data().owner === currentUser.uid ? `<button class="delete-board-btn text-gray-400 hover:text-red-500" data-plan-id="${planId}"><i class="fas fa-trash-alt"></i></button>` : ''}`;
                boardList.appendChild(card);
            });
            appLoader.style.display = 'none';
        };

        const renderShareModal = async () => {
            membersList.innerHTML = '';
            for (const uid in appData.members) {
                const userRef = doc(db, "users", uid);
                const userSnap = await getDoc(userRef);
                const userEmail = userSnap.exists() ? userSnap.data().email : "Utilizador desconhecido";
                const role = appData.members[uid];

                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-2 bg-gray-100 dark:bg-gray-700 rounded-md';
                
                let content = `<span>${userEmail} (${role})</span>`;

                if (appData.owner === currentUser.uid && uid !== currentUser.uid) {
                    content += `
                        <div class="flex items-center gap-2">
                            <select class="role-select dark:bg-gray-600 rounded-md text-sm" data-uid="${uid}">
                                <option value="viewer" ${role === 'viewer' ? 'selected' : ''}>Visualizador</option>
                                <option value="editor" ${role === 'editor' ? 'selected' : ''}>Editor</option>
                            </select>
                            <button class="remove-member-btn text-red-500" data-uid="${uid}"><i class="fas fa-times"></i></button>
                        </div>`;
                }
                li.innerHTML = content;
                membersList.appendChild(li);
            }
        };


        // --- AUTH LOGIC ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                authScreen.classList.add('hidden');
                showBoardSelection();
            } else {
                currentUser = null;
                authScreen.classList.remove('hidden');
                boardSelectionScreen.classList.add('hidden');
                mainApp.classList.add('hidden');
            }
            appLoader.style.display = 'none';
        });

        registerBtn.addEventListener('click', () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            authError.textContent = '';
            createUserWithEmailAndPassword(auth, email, password)
                .then(async (userCredential) => {
                    await setDoc(doc(db, "users", userCredential.user.uid), { email: email });
                })
                .catch(error => { authError.textContent = error.message; });
        });

        loginBtn.addEventListener('click', () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            authError.textContent = '';
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => { authError.textContent = error.message; });
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        // --- Event Listeners ---
        
        boardList.addEventListener('click', (e) => {
            const card = e.target.closest('[data-plan-id]');
            if (!card) return;
            const planId = card.dataset.planId;
            if (e.target.closest('.delete-board-btn')) {
                 if (confirm("Tem a certeza?")) {
                    deleteDoc(doc(db, "plans", planId)).then(showBoardSelection);
                }
            } else {
                 loadPlan(planId);
            }
        });

        addBoardBtn.addEventListener('click', async () => {
            const name = newBoardNameInput.value.trim();
            if (!name) return;
            
            const newPlanId = Date.now().toString();
            const newPlanData = {
                ...emptyData,
                title: name,
                owner: currentUser.uid,
                members: { [currentUser.uid]: 'owner' },
                memberIds: [currentUser.uid]
            };

            await saveData(newPlanId, newPlanData);
            newBoardNameInput.value = '';
            showBoardSelection();
        });
        
        shareBtn.addEventListener('click', () => {
            renderShareModal();
            shareModal.classList.remove('hidden');
        });

        closeShareModalBtn.addEventListener('click', () => shareModal.classList.add('hidden'));

        inviteBtn.addEventListener('click', async () => {
            const email = inviteEmailInput.value.trim();
            const role = inviteRoleSelect.value;
            if (!email) return;

            const usersRef = collection(db, "users");
            const q = query(usersRef, where("email", "==", email));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                alert("Utilizador não encontrado.");
                return;
            }

            const userDoc = querySnapshot.docs[0];
            const userId = userDoc.id;

            if (appData.memberIds.includes(userId)) {
                alert("Este utilizador já é membro.");
                return;
            }

            appData.members[userId] = role;
            appData.memberIds.push(userId);
            await saveCurrentPlanData();
            renderShareModal();
            inviteEmailInput.value = '';
        });

        membersList.addEventListener('click', async (e) => {
            const uid = e.target.dataset.uid;
            if (!uid) return;

            if (e.target.classList.contains('role-select')) {
                const newRole = e.target.value;
                appData.members[uid] = newRole;
                await saveCurrentPlanData();
                renderShareModal();
            } else if (e.target.closest('.remove-member-btn')) {
                delete appData.members[uid];
                appData.memberIds = appData.memberIds.filter(id => id !== uid);
                await saveCurrentPlanData();
                renderShareModal();
            }
        });

        backToBoardsBtn.addEventListener('click', showBoardSelection);
        editMainTitleBtn.addEventListener('click', () => { /* ... edit title logic ... */ });
        addCategoryBtn.addEventListener('click', () => { /* ... add category logic ... */ });
        categoriesContainer.addEventListener('click', (e) => { /* ... item/category logic ... */ });
        const applyTheme = (theme) => { /* ... theme logic ... */ };
        themeToggleBtn.addEventListener('click', () => { /* ... theme toggle logic ... */ });
        const switchView = (view) => { /* ... view switch logic ... */ };
        viewKanbanBtn.addEventListener('click', () => switchView('kanban'));
        viewListBtn.addEventListener('click', () => switchView('list'));
        viewCalendarBtn.addEventListener('click', () => switchView('calendar'));
        viewDashboardBtn.addEventListener('click', () => switchView('dashboard'));
        const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        applyTheme(savedTheme);

    </script>
</body>
</html>

